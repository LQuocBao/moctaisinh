<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Admin | taisinh.vn – Quản trị hệ thống</title>
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --main-blue: #7EC8E3;
      --main-blue-dark: #5bb0d6;
      --main-white: #fff;
      --main-silver: #e0e0e0;
    }

    body {
      background: var(--main-white);
    }

    .admin-sidebar {
      background: var(--main-blue);
      color: #fff;
      min-height: 100vh;
      padding: 32px 0 0 0;
      position: fixed;
      left: 0;
      top: 0;
      width: 220px;
      z-index: 1040;
      transition: transform 0.4s cubic-bezier(.4, 2, .6, 1);
      transform: translateX(0);
      box-shadow: 2px 0 8px rgba(126, 200, 227, 0.08);
    }

    .admin-sidebar.closed {
      transform: translateX(-100%);
    }

    .admin-sidebar h2 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 2rem;
      text-align: center;
      color: #fff;
      border-radius: 12px;
      padding: 12px 0;
      box-shadow: none;
      border: none;
    }

    .admin-sidebar ul {
      list-style: none;
      padding: 0;
    }

    .admin-sidebar li {
      margin-bottom: 18px;
    }

    .admin-sidebar a {
      color: #fff;
      font-weight: 500;
      display: block;
      padding: 10px 32px;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .admin-sidebar a.active,
    .admin-sidebar a:hover {
      background: var(--main-blue-dark);
      text-decoration: none;
      color: #fff;
    }

    .admin-sidebar a,
    .admin-sidebar a:active,
    .admin-sidebar a:focus,
    .admin-sidebar a:hover {
      text-decoration: none !important;
    }

    .admin-content {
      padding: 40px 32px;
      margin-left: 220px;
      transition: margin-left 0.4s cubic-bezier(.4, 2, .6, 1);
      min-height: 100vh;
      background: var(--main-white);
    }

    .sidebar-closed .admin-content {
      margin-left: 0;
    }

    .admin-table th,
    .admin-table td {
      vertical-align: middle;
    }

    .admin-table th {
      background: var(--main-blue);
      color: #fff;
      border-bottom: 2px solid var(--main-silver);
    }

    .admin-table tr {
      background: var(--main-white);
    }

    .admin-table tr:nth-child(even) {
      background: #f5fafd;
    }

    .admin-table th,
    .admin-table td {
      max-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-color: var(--main-silver);
    }

    .admin-table td:nth-child(4) {
      white-space: normal;
      word-break: break-word;
      max-width: 250px;
    }

    /* Blog table specific styles */
    #blogsTable td:nth-child(3) {
      white-space: normal;
      word-break: break-word;
      max-width: 350px;
    }

    #blogsTable td:nth-child(2) {
      max-width: 250px;
    }

    #blogsTable td:nth-child(4) {
      max-width: 120px;
    }

    #blogsTable td:nth-child(5) {
      max-width: 100px;
    }

    /* Make admin content wider for better table display */
    .admin-content {
      padding: 40px 32px;
      margin-left: 220px;
      transition: margin-left 0.4s cubic-bezier(.4, 2, .6, 1);
      min-height: 100vh;
      background: var(--main-white);
      max-width: none;
    }

    /* Make order modal wider */
    #orderModal .modal-dialog {
      max-width: 900px;
      width: 90%;
    }

    /* Order status select styling */
    .order-status-select {
      width: auto;
      min-width: 110px;
      max-width: 130px;
      border-radius: 6px;
      border: 2px solid;
      font-size: 0.85rem;
      font-weight: 500;
      padding: 4px 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .order-status-select:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .order-status-select:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .order-status-select option {
      background-color: #fff;
      color: #333;
      padding: 8px 12px;
      font-size: 0.85rem;
    }

    .order-status-select.status-pending {
      background-color: #fff3cd;
      color: #856404;
      border-color: #ffeaa7;
    }

    .order-status-select.status-confirmed {
      background-color: #d1ecf1;
      color: #0c5460;
      border-color: #bee5eb;
    }

    .order-status-select.status-shipping {
      background-color: #cce5ff;
      color: #004085;
      border-color: #b3d7ff;
    }

    .order-status-select.status-delivered {
      background-color: #d4edda;
      color: #155724;
      border-color: #c3e6cb;
    }

    .order-status-select.status-cancelled {
      background-color: #f8d7da;
      color: #721c24;
      border-color: #f5c6cb;
    }

    .admin-table td img {
      max-width: 60px;
      max-height: 60px;
      border: 1px solid var(--main-silver);
      background: var(--main-silver);
      border-radius: 6px;
    }

    .admin-section-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 24px;
      color: var(--main-blue-dark);
    }

    .admin-btn {
      border-radius: 8px;
      padding: 8px 18px;
      font-weight: 500;
      background: var(--main-blue);
      color: #fff;
      border: none;
      transition: background 0.2s;
    }

    .admin-btn:hover,
    .admin-btn:focus {
      background: var(--main-blue-dark);
      color: #fff;
    }

    .admin-btn.btn-danger {
      background: #e74c3c;
      color: #fff;
      border: none;
    }

    .admin-btn.btn-danger:hover,
    .admin-btn.btn-danger:focus {
      background: #c0392b;
      color: #fff;
    }

    .admin-btn+.admin-btn {
      margin-left: 8px;
    }

    .modal-header {
      background: var(--main-blue);
      color: #fff;
      border-bottom: 1px solid var(--main-silver);
    }

    .form-label {
      font-weight: 500;
      color: var(--main-blue-dark);
    }

    .form-control,
    .form-select {
      border-radius: 8px;
      border: 1px solid var(--main-silver);
      background: var(--main-white);
      color: #222;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--main-blue);
      box-shadow: 0 0 0 2px #b3e0ff33;
    }

    /* Highlight required fields */
    .form-control:invalid,
    .form-select:invalid {
      border-color: #dc3545;
      box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.25);
    }

    .form-control:invalid:focus,
    .form-select:invalid:focus {
      border-color: #dc3545;
      box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.25);
    }

    .admin-nav-mobile {
      display: none;
    }

    .sidebar-toggle-btn {
      position: fixed;
      top: 18px;
      left: 18px;
      z-index: 1100;
      background: var(--main-blue);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 1.5rem;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(126, 200, 227, 0.08);
      transition: background 0.2s;
    }

    .sidebar-toggle-btn:hover {
      background: var(--main-blue-dark);
    }

    .sticky-toolbar {
      position: sticky;
      top: 0;
      z-index: 20;
      background: var(--main-white);
      padding-top: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--main-silver);
    }

    .pagination .page-link {
      color: var(--main-blue-dark);
      border: 1px solid var(--main-silver);
      background: var(--main-white);
    }

    .pagination .page-item.active .page-link {
      background: var(--main-blue-dark);
      color: #fff;
      border-color: var(--main-blue-dark);
    }

    @media (max-width: 1200px) {
      .admin-sidebar {
        width: 180px;
      }

      .admin-content {
        margin-left: 180px;
      }
    }

    @media (max-width: 1024px) {
      .admin-sidebar {
        width: 160px;
        padding: 12px 0;
      }

      .admin-content {
        margin-left: 160px;
        padding: 18px 4px;
      }

      .admin-section-title {
        font-size: 1.1rem;
      }

      .admin-btn,
      .admin-btn.btn-success,
      .admin-btn.btn-danger {
        padding: 7px 12px;
        font-size: 1rem;
      }

      .form-control,
      .form-select {
        font-size: 1rem;
      }

      .modal-dialog {
        max-width: 95vw;
      }

      .modal-content {
        font-size: 1rem;
      }

      .sticky-toolbar {
        top: 0;
      }

      .admin-table th,
      .admin-table td {
        font-size: 0.98rem;
      }

      .admin-table {
        font-size: 0.98rem;
      }

      .admin-table-wrapper {
        overflow-x: auto;
      }
    }

    @media (max-width: 834px) {
      .admin-sidebar {
        width: 120px;
        padding: 8px 0;
      }

      .admin-content {
        margin-left: 120px;
        padding: 10px 2px;
      }

      .admin-section-title {
        font-size: 1rem;
      }

      .admin-btn,
      .admin-btn.btn-success,
      .admin-btn.btn-danger {
        padding: 6px 8px;
        font-size: 0.95rem;
      }

      .form-control,
      .form-select {
        font-size: 0.95rem;
      }

      .modal-dialog {
        max-width: 99vw;
      }

      .modal-content {
        font-size: 0.95rem;
      }

      .sticky-toolbar {
        top: 0;
      }

      .admin-table th,
      .admin-table td {
        font-size: 0.95rem;
      }

      .admin-table {
        font-size: 0.95rem;
      }
    }

    /* Toast đẹp hơn, hiệu ứng trượt phải vào, bo góc, icon */
    .custom-toast {
      min-width: 240px;
      margin-bottom: 12px;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      padding: 12px 18px;
      font-size: 1rem;
      position: relative;
      animation: slideInRight 0.5s cubic-bezier(.4, 2, .6, 1) both;
      opacity: 1;
      transition: opacity 0.7s;
    }

    .custom-toast.fade-out {
      opacity: 0;
      pointer-events: none;
      transition: opacity 1s;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .toast-success {
      background: #e6f9ed;
      color: #1a7f37;
      border-left: 6px solid #1a7f37;
    }

    .toast-error {
      background: #ffeaea;
      color: #d32f2f;
      border-left: 6px solid #d32f2f;
    }

    .toast-warning {
      background: #fffbe6;
      color: #bfa100;
      border-left: 6px solid #bfa100;
    }

    .custom-toast .toast-icon {
      font-size: 1.3em;
      margin-right: 12px;
    }

    .custom-toast .toast-close {
      position: absolute;
      right: 10px;
      top: 10px;
      background: none;
      border: none;
      color: inherit;
      font-size: 1.1em;
      cursor: pointer;
    }

    .sticky-toolbar {
      position: sticky;
      top: 0;
      z-index: 20;
      background: var(--main-white);
      padding-top: 8px;
      padding-bottom: 8px;
    }

    .admin-btn.btn-cancel {
      background: var(--main-blue);
      color: #fff;
      border: none;
    }

    .admin-btn.btn-cancel:hover,
    .admin-btn.btn-cancel:focus {
      background: var(--main-blue-dark);
      color: #fff;
    }

    .admin-btn.btn-sm {
      min-width: 64px;
      padding: 6px 14px;
      font-size: 1rem;
    }

    .admin-form-btn-full {
      width: 100%;
      min-width: 120px;
      padding: 10px 0;
      font-size: 1.08rem;
      border-radius: 8px;
      margin-top: 8px;
    }

    /* Auto-resize textarea */
    #productImage {
      resize: vertical;
      min-height: 250px;
      max-height: 500px;
      font-family: monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      width: 100%;
      overflow-y: auto;
    }

    /* Auto-expand textarea on input */
    #productImage:focus {
      min-height: 300px;
    }

    /* Modal wider for better UX */
    #productModal .modal-dialog {
      max-width: 1200px;
    }

    /* Two column layout for product form */
    .product-form-row {
      display: flex;
      gap: 32px;
    }

    .product-form-col {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .product-form-col .mb-3 {
      margin-bottom: 0 !important;
    }

    .product-form-col-right {
      display: flex;
      flex-direction: column;
      gap: 18px;
      height: 100%;
      justify-content: stretch;
    }

    .product-form-col-right .mb-3 {
      background: #f8fbff;
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(126, 200, 227, 0.07);
      border: 1.5px solid #e0f0fa;
      padding: 18px 16px 10px 16px;
      display: flex;
      flex-direction: column;
      min-width: 0;
      width: 100%;
      flex: 1 1 0;
    }

    .product-form-col-right label.form-label {
      font-weight: 600;
      color: #3b5d50;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 1.05rem;
    }

    .product-form-col-right label[for="productStory"]::before {
      content: '\f02d';
      /* fa-book-open */
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: #7EC8E3;
      margin-right: 6px;
      font-size: 1.1em;
    }

    .product-form-col-right label[for="productImage"]::before {
      content: '\f03e';
      /* fa-image */
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: #7EC8E3;
      margin-right: 6px;
      font-size: 1.1em;
    }

    #productStory {
      background: #fff;
      border-radius: 8px;
      border: 1.5px solid #e0f0fa;
      transition: border-color 0.2s;
      font-size: 1rem;
      min-height: 180px;
      height: 220px;
      flex: 1 1 0;
      margin-bottom: 0;
      width: 100%;
    }

    #productImage {
      background: #fff;
      border-radius: 8px;
      border: 1.5px solid #e0f0fa;
      transition: border-color 0.2s;
      font-size: 1rem;
      min-height: 120px;
      height: 140px;
      flex: 1 1 0;
      margin-bottom: 0;
      width: 100%;
    }

    #productStory:focus,
    #productImage:focus {
      border-color: #7EC8E3;
      box-shadow: 0 0 0 2px #b6e6fa;
    }

    @media (max-width: 900px) {

      .product-form-row,
      .product-form-col-right {
        flex-direction: column;
        gap: 0;
      }
    }

    .product-form-row-2 {
      display: flex;
      gap: 18px;
      margin-top: 0;
    }

    .product-form-row-2>.mb-3 {
      flex: 1;
      margin-bottom: 0 !important;
    }

    #productDescription {
      min-height: 120px;
      height: 140px;
      resize: vertical;
    }

    #productStory,
    #productImage {
      min-height: 120px;
      height: 120px;
      resize: vertical;
    }

    @media (max-width: 900px) {
      #productModal .modal-dialog {
        max-width: 98vw;
      }

      .product-form-row,
      .product-form-row-2 {
        flex-direction: column;
        gap: 0;
      }
    }

    .product-form-row-2 {
      display: flex;
      gap: 18px;
      margin-top: 0;
    }

    .product-form-row-2>.mb-3 {
      flex: 1;
      margin-bottom: 0 !important;
      background: #f8fbff;
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(126, 200, 227, 0.07);
      border: 1.5px solid #e0f0fa;
      padding: 18px 16px 10px 16px;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .product-form-row-2 label.form-label {
      font-weight: 600;
      color: #3b5d50;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 1.05rem;
    }

    .product-form-row-2 label[for="productStory"]::before {
      content: '\f02d';
      /* fa-book-open */
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: #7EC8E3;
      margin-right: 6px;
      font-size: 1.1em;
    }

    .product-form-row-2 label[for="productImage"]::before {
      content: '\f03e';
      /* fa-image */
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: #7EC8E3;
      margin-right: 6px;
      font-size: 1.1em;
    }

    #productStory {
      background: #fff;
      border-radius: 8px;
      border: 1.5px solid #e0f0fa;
      transition: border-color 0.2s;
      font-size: 1rem;
      min-height: 220px;
      height: 240px;
      margin-bottom: 0;
    }

    #productImage {
      background: #fff;
      border-radius: 8px;
      border: 1.5px solid #e0f0fa;
      transition: border-color 0.2s;
      font-size: 1rem;
      min-height: 120px;
      height: 140px;
      margin-bottom: 0;
    }

    #productStory:focus,
    #productImage:focus {
      border-color: #7EC8E3;
      box-shadow: 0 0 0 2px #b6e6fa;
    }

    @media (max-width: 900px) {
      .product-form-row-2 {
        flex-direction: column;
        gap: 0;
      }
    }

    /* Image Gallery Styles - Giống như trong detail */
    .image-gallery-container {
      margin-top: 15px;
      border: 2px dashed #e0f0fa;
      border-radius: 12px;
      padding: 20px;
      background: #fafbfc;
      min-height: 200px;
    }

    .image-gallery-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }

    .image-preview-item {
      position: relative;
      display: inline-block;
      text-align: center;
      margin: 0;
    }

    .image-preview-item img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border: 2px solid #e0f0fa;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #fff;
    }

    .image-preview-item img:hover {
      border-color: #7EC8E3;
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(126, 200, 227, 0.2);
    }

    .image-preview-item .image-label {
      font-size: 0.85rem;
      color: #3b5d50;
      margin-top: 5px;
      font-weight: 500;
    }

    .image-remove-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 12px;
      line-height: 1;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3);
      transition: all 0.2s ease;
    }

    .image-remove-btn:hover {
      background: #c82333;
      transform: scale(1.1);
    }

    .image-gallery-empty {
      text-align: center;
      color: #6c757d;
      font-style: italic;
      padding: 40px 20px;
    }

    .image-gallery-empty i {
      font-size: 2rem;
      margin-bottom: 10px;
      color: #dee2e6;
    }

    .image-gallery-warning {
      text-align: center;
      color: #856404;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      font-size: 0.9rem;
    }

    .image-gallery-warning i {
      font-size: 1.5rem;
      margin-bottom: 8px;
      color: #f39c12;
    }

    /* Image Modal Styles */
    .image-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(5px);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-image-content {
      position: relative;
      margin: auto;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 20px;
      cursor: pointer;
    }

    .modal-image {
      max-width: 90%;
      max-height: 80%;
      object-fit: contain;
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      transform-origin: center center;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      color: #fff;
      font-size: 35px;
      font-weight: bold;
      cursor: pointer;
      background: rgba(0, 0, 0, 0.5);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.8);
      transform: scale(1.1);
    }

    .modal-controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 15px;
      z-index: 10001;
    }

    .control-btn {
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: scale(1);
    }

    .control-btn:hover {
      background: rgba(0, 0, 0, 0.95);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
      transform: scale(1.1);
    }

    .control-btn:active {
      transform: scale(0.95);
      transition: transform 0.1s ease;
    }

    /* Thumbnail Gallery in Modal */
    .modal-thumbnails {
      position: absolute;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 10001;
      max-width: 80%;
      overflow-x: auto;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 20px;
      backdrop-filter: blur(10px);
    }

    .modal-thumbnail {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      opacity: 0.7;
      transform: scale(1);
    }

    .modal-thumbnail:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .modal-thumbnail.active {
      border-color: #fff;
      opacity: 1;
      box-shadow: 0 2px 8px rgba(255, 255, 255, 0.3);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .image-gallery-preview {
        gap: 10px;
      }

      .image-preview-item img {
        width: 80px;
        height: 80px;
      }

      .modal-image {
        max-width: 95%;
        max-height: 70%;
      }

      .modal-close {
        top: 10px;
        right: 15px;
        width: 40px;
        height: 40px;
        font-size: 25px;
      }
    }
  </style>
</head>

<body>
  <div id="globalLoading"
    style="display:none;position:fixed;z-index:20000;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.55);backdrop-filter:blur(2px);align-items:center;justify-content:center;">
    <div style="display:flex;flex-direction:column;align-items:center;">
      <div class="spinner-border text-info" style="width:3rem;height:3rem;" role="status"></div>
      <div style="margin-top:12px;font-weight:500;color:#3b5d50;">Chờ chút nhé...</div>
    </div>
  </div>
  <div class="container-fluid">
    <!-- Toast thông báo -->
    <div id="toastContainer" style="position: fixed; top: 24px; right: 24px; z-index: 9999;"></div>
    <!-- Image Modal for Gallery -->
    <div id="imageModal" class="image-modal">
      <div class="modal-image-content">
        <span class="modal-close" onclick="closeImageModal()">&times;</span>
        <img class="modal-image" id="modalImage" alt="Product Image">
        <div class="modal-thumbnails" id="modalThumbnails"></div>
        <div class="modal-controls">
          <button class="control-btn" onclick="zoomOut()" title="Thu nhỏ">
            <i class="fas fa-search-minus"></i>
          </button>
          <button class="control-btn" onclick="resetZoom()" title="Vị trí mặc định">
            <i class="fas fa-undo"></i>
          </button>
          <button class="control-btn" onclick="zoomIn()" title="Phóng to">
            <i class="fas fa-search-plus"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="row">
      <nav class="col-lg-2 admin-sidebar d-none d-lg-block">
        <h2>Admin Panel</h2>
        <ul>
          <li><a href="#products" class="active" data-tab="products">Quản lý sản phẩm</a></li>
          <li><a href="#blogs" data-tab="blogs">Quản lý blog</a></li>
          <li><a href="#orders" data-tab="orders">Quản lý đơn hàng</a></li>
        </ul>
      </nav>
      <div class="col-lg-10 admin-content">
        <div class="admin-nav-mobile mb-3">
          <select class="form-select" id="adminTabMobile">
            <option value="products">Quản lý sản phẩm</option>
            <option value="blogs">Quản lý blog</option>
            <option value="orders">Quản lý đơn hàng</option>
          </select>
        </div>
        <div id="tab-products" class="admin-tab">
          <div class="admin-section-title d-flex align-items-center justify-content-between">
            <span>Quản lý sản phẩm</span>
            <span id="productCount" style="font-size:1rem;font-weight:400;color:#3b5d50;"></span>
          </div>
          <div class="sticky-toolbar d-flex align-items-center justify-content-between mb-3">
            <button class="admin-btn btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#productModal"
              id="btnAddProduct">+ Thêm sản phẩm</button>
            <button class="admin-btn btn btn-success mb-3" id="productCountBtn">Tổng: 0 sản phẩm</button>
          </div>
          <div class="mb-3 d-flex align-items-center" style="gap:12px;">
            <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm theo tên, giá, mô tả..."
              style="max-width:320px;">
          </div>
          <div class="admin-table-wrapper">
            <table class="table admin-table" id="productsTable">
              <thead>
                <tr>
                  <th style="cursor:pointer;" onclick="sortTable('id')">ID <span id="sortIcon-id"></span></th>
                  <th style="cursor:pointer;" onclick="sortTable('name')">Tên sản phẩm <span id="sortIcon-name"></span>
                  </th>
                  <th style="cursor:pointer;" onclick="sortTable('price')">Giá <span id="sortIcon-price"></span></th>
                  <th style="cursor:pointer;" onclick="sortTable('description')">Mô tả <span
                      id="sortIcon-description"></span></th>
                  <th>Ảnh</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody>
                <!-- Sản phẩm sẽ được render ở đây bằng JS -->
              </tbody>
            </table>
          </div>
          <nav>
            <ul class="pagination" id="pagination" style="justify-content:center;"></ul>
          </nav>
        </div>
        <div id="tab-blogs" class="admin-tab d-none">
          <div class="admin-section-title d-flex align-items-center justify-content-between">
            <span>Quản lý blog</span>
            <span id="blogCount" style="font-size:1rem;font-weight:400;color:#3b5d50;"></span>
          </div>
          <div class="sticky-toolbar d-flex align-items-center justify-content-between mb-3">
            <button class="admin-btn btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#blogModal"
              id="btnAddBlog">+ Thêm bài viết</button>
            <button class="admin-btn btn btn-success mb-3" id="blogCountBtn">Tổng: 0 bài viết</button>
          </div>
          <div class="mb-3 d-flex align-items-center" style="gap:12px;">
            <input type="text" class="form-control" id="searchBlogInput"
              placeholder="Tìm kiếm tiêu đề, nội dung, tác giả..." style="max-width:320px;">
          </div>
          <div class="admin-table-wrapper">
            <table class="table admin-table" id="blogsTable">
              <thead>
                <tr>
                  <th style="cursor:pointer;" onclick="sortBlogTable('id')">ID <span id="sortBlogIcon-id"></span></th>
                  <th style="cursor:pointer;" onclick="sortBlogTable('title')">Tiêu đề <span
                      id="sortBlogIcon-title"></span></th>
                  <th style="cursor:pointer;" onclick="sortBlogTable('content')">Nội dung <span
                      id="sortBlogIcon-content"></span></th>
                  <th style="cursor:pointer;" onclick="sortBlogTable('author')">Tác giả <span
                      id="sortBlogIcon-author"></span></th>
                  <th style="cursor:pointer;" onclick="sortBlogTable('date')">Ngày <span id="sortBlogIcon-date"></span>
                  </th>
                  <th>Ảnh</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <nav>
            <ul class="pagination" id="blogPagination" style="justify-content:center;"></ul>
          </nav>
        </div>
        <div id="tab-orders" class="admin-tab d-none">
          <div class="admin-section-title d-flex align-items-center justify-content-between">
            <span>Quản lý đơn hàng</span>
            <button class="admin-btn btn-sm" id="orderCountBtn" style="pointer-events:auto;">Tổng: 0 đơn hàng</button>
          </div>
          <div class="sticky-toolbar d-flex align-items-center justify-content-between mb-3">
            <button class="admin-btn btn-sm" data-bs-toggle="modal" data-bs-target="#orderModal" id="btnAddOrder">+ Thêm
              đơn hàng</button>
            <input type="text" class="form-control" id="searchOrderInput"
              placeholder="Tìm kiếm theo mã đơn hàng, tên khách hàng..." style="max-width:320px;">
          </div>
          <div class="admin-table-wrapper">
            <table class="table admin-table" id="ordersTable">
              <thead>
                <tr>
                  <th style="cursor:pointer;" onclick="sortOrderTable('id')">Mã đơn hàng <span
                      id="sortOrderIcon-id"></span></th>
                  <th style="cursor:pointer;" onclick="sortOrderTable('date')">Ngày đặt <span
                      id="sortOrderIcon-date"></span></th>
                  <th style="cursor:pointer;" onclick="sortOrderTable('customerName')">Khách hàng <span
                      id="sortOrderIcon-customerName"></span></th>
                  <th style="cursor:pointer;" onclick="sortOrderTable('customerPhone')">Số điện thoại <span
                      id="sortOrderIcon-customerPhone"></span></th>
                  <th style="cursor:pointer;" onclick="sortOrderTable('total')">Tổng tiền <span
                      id="sortOrderIcon-total"></span></th>
                  <th style="cursor:pointer;" onclick="sortOrderTable('status')">Trạng thái <span
                      id="sortOrderIcon-status"></span></th>
                  <th>Chi tiết</th>
                  <th>Thao tác</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <nav>
            <ul class="pagination" id="orderPagination" style="justify-content:center;"></ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="productModalLabel">Thêm/Sửa sản phẩm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="productForm">
            <input type="hidden" id="productRowIndex">
            <div class="mb-3" id="productIdGroup" style="display:none;">
              <label class="form-label">ID</label>
              <input type="text" class="form-control" id="productId" readonly>
            </div>
            <div class="product-form-row">
              <div class="product-form-col">
                <div class="mb-3">
                  <label class="form-label">Tên sản phẩm *</label>
                  <input type="text" class="form-control" id="productName" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Giá *</label>
                  <input type="text" class="form-control" id="productPrice" required inputmode="numeric"
                    placeholder="000.000₫">
                </div>
                <div class="mb-3">
                  <label class="form-label">Mô tả *</label>
                  <textarea class="form-control" id="productDescription" rows="5" required></textarea>
                </div>
                <div class="mb-3">
                  <label class="form-label">Chất liệu *</label>
                  <input type="text" class="form-control" id="productMaterial" required
                    placeholder="Ví dụ: Gỗ sồi, Tre già, Vải bố...">
                </div>
                <div class="mb-3">
                  <label class="form-label">Kích thước *</label>
                  <input type="text" class="form-control" id="productSize" required
                    placeholder="Ví dụ: 120×60cm, 80×40×45cm...">
                </div>
                <div class="mb-3">
                  <label class="form-label">Trọng lượng *</label>
                  <input type="text" class="form-control" id="productWeight" required
                    placeholder="Ví dụ: 8.5kg, 12kg...">
                </div>
                <div class="mb-3">
                  <label class="form-label">Tình trạng</label>
                  <select class="form-control" id="productStatus">
                    <option value="Còn hàng">Còn hàng</option>
                    <option value="Hết hàng">Hết hàng</option>
                    <option value="Đặt hàng trước">Đặt hàng trước</option>
                  </select>
                </div>
              </div>
              <div class="product-form-col product-form-col-right">
                <div class="mb-3" style="width:100%;flex:1;">
                  <label class="form-label" for="productFeatures">Đặc điểm nổi bật * (mỗi dòng 1 đặc điểm)</label>
                  <textarea class="form-control" id="productFeatures" rows="4" required
                    placeholder="Làm thủ công 100% từ tre già tự nhiên&#10;Thiết kế độc bản, không trùng lặp&#10;Bảo hành 2 năm, bảo trì trọn đời&#10;Vận chuyển miễn phí toàn quốc"></textarea>
                </div>
                <div class="mb-3" style="width:100%;flex:1;">
                  <label class="form-label" for="productStory">Câu chuyện đằng sau sản phẩm *</label>
                  <textarea class="form-control" id="productStory" rows="8" required
                    placeholder="Kể câu chuyện về nguồn gốc, quá trình làm ra sản phẩm, ý nghĩa văn hóa..."></textarea>
                </div>
                <div class="mb-3" style="width:100%;flex:1;">
                  <label class="form-label" for="productImage">Ảnh sản phẩm * (URL, mỗi dòng 1 link, tối đa 4
                    ảnh)</label>
                  <div class="mb-2">
                    <a href="https://imgbb.com/" target="_blank"
                      style="color: #007bff; text-decoration: underline; font-size: 0.9rem;">
                      📷 Bấm vào đây để lấy URL ảnh
                    </a>
                  </div>
                  <textarea class="form-control" id="productImage" rows="4" required
                    placeholder="https://...jpg&#10;https://...png&#10;https://...webp"
                    style="min-height: 120px;"></textarea>
                  <!-- Image Gallery Preview -->
                  <div class="image-gallery-container">
                    <div class="image-gallery-preview" id="imageGalleryPreview">
                      <div class="image-gallery-empty">
                        <i class="fas fa-images"></i>
                        <div>Chưa có ảnh nào</div>
                        <small>Nhập URL ảnh vào ô bên trên để xem preview</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <button class="admin-btn btn-sm admin-form-btn-full" type="submit">Lưu</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal xác nhận xoá -->
  <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteConfirmLabel">Xác nhận xoá sản phẩm</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Bạn có chắc chắn muốn xoá sản phẩm này không?
        </div>
        <div class="modal-footer">
          <button type="button" class="admin-btn btn-cancel btn-sm" data-bs-dismiss="modal">Huỷ</button>
          <button type="button" class="admin-btn btn-danger btn-sm" id="btnConfirmDelete">Xoá</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal Thêm/Sửa Blog -->
  <div class="modal fade" id="blogModal" tabindex="-1" aria-labelledby="blogModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="blogModalLabel">Thêm/Sửa bài viết</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="blogForm">
            <input type="hidden" id="blogRowIndex">
            <div class="mb-3" id="blogIdGroup" style="display:none;">
              <label class="form-label">ID</label>
              <input type="text" class="form-control" id="blogId" readonly>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Tiêu đề *</label>
                  <input type="text" class="form-control" id="blogTitle" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Tác giả *</label>
                  <input type="text" class="form-control" id="blogAuthor" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ngày *</label>
                  <input type="date" class="form-control" id="blogDate" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">URL Ảnh</label>
                  <div class="mb-2">
                    <a href="https://imgbb.com/" target="_blank"
                      style="color: #007bff; text-decoration: underline; font-size: 0.9rem;">
                      📷 Bấm vào đây để lấy URL ảnh
                    </a>
                  </div>
                  <input type="url" class="form-control" id="blogImage" placeholder="https://example.com/image.jpg">
                  <!-- Blog Image Preview -->
                  <div class="blog-image-preview mt-2" id="blogImagePreview" style="display:none;">
                    <img src="" alt="Blog preview"
                      style="max-width:200px;max-height:150px;border-radius:4px;border:1px solid #ddd;cursor:pointer;"
                      onclick="showBlogImageModal(this.src)">
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Nội dung *</label>
                  <textarea class="form-control" id="blogContent" rows="12" required
                    placeholder="Nhập nội dung bài viết..."></textarea>
                </div>
              </div>
            </div>
            <button class="admin-btn btn-sm admin-form-btn-full" type="submit">Lưu</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal xác nhận xoá blog -->
  <div class="modal fade" id="deleteBlogConfirmModal" tabindex="-1" aria-labelledby="deleteBlogConfirmLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background:var(--main-blue);color:#fff;">
          <h5 class="modal-title" id="deleteBlogConfirmLabel">Xác nhận xoá bài viết</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Bạn có chắc chắn muốn xoá bài viết này không?
        </div>
        <div class="modal-footer">
          <button type="button" class="admin-btn btn-cancel btn-sm" data-bs-dismiss="modal">Huỷ</button>
          <button type="button" class="admin-btn btn-danger btn-sm" id="btnConfirmDeleteBlog">Xoá</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal đơn hàng -->
  <div class="modal fade" id="orderModal" tabindex="-1" aria-labelledby="orderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="orderModalLabel">Thêm/Sửa đơn hàng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="orderForm">
            <input type="hidden" id="orderRowIndex">
            <div class="mb-3" id="orderIdGroup" style="display:none;">
              <label class="form-label">Mã đơn hàng</label>
              <input type="text" class="form-control" id="orderId" readonly>
            </div>
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Tên khách hàng *</label>
                  <input type="text" class="form-control" id="orderCustomerName" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Số điện thoại *</label>
                  <input type="tel" class="form-control" id="orderCustomerPhone" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" id="orderCustomerEmail">
                </div>
                <div class="mb-3">
                  <label class="form-label">Địa chỉ *</label>
                  <textarea class="form-control" id="orderCustomerAddress" rows="2" required></textarea>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label class="form-label">Tỉnh/Thành phố *</label>
                  <input type="text" class="form-control" id="orderCustomerProvince" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Quận/Huyện *</label>
                  <input type="text" class="form-control" id="orderCustomerDistrict" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Phường/Xã *</label>
                  <input type="text" class="form-control" id="orderCustomerWard" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">Tổng tiền *</label>
                  <input type="text" class="form-control" id="orderTotal" required placeholder="000.000₫">
                </div>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Sản phẩm *</label>
              <textarea class="form-control" id="orderItems" rows="3" required
                placeholder="Ví dụ: Bàn gỗ sồi (x1), Ghế tre (x2)"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Ghi chú</label>
              <textarea class="form-control" id="orderNote" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Trạng thái *</label>
              <select class="form-control" id="orderStatus" required>
                <option value="Chờ xử lý">Chờ xử lý</option>
                <option value="Đã xác nhận">Đã xác nhận</option>
                <option value="Đang giao hàng">Đang giao hàng</option>
                <option value="Đã giao hàng">Đã giao hàng</option>
                <option value="Đã hủy">Đã hủy</option>
              </select>
            </div>
            <button class="admin-btn btn-sm admin-form-btn-full" type="submit">Lưu</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal xác nhận xoá đơn hàng -->
  <div class="modal fade" id="deleteOrderConfirmModal" tabindex="-1" aria-labelledby="deleteOrderConfirmLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header" style="background:var(--main-blue);color:#fff;">
          <h5 class="modal-title" id="deleteOrderConfirmLabel">Xác nhận xoá đơn hàng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Bạn có chắc chắn muốn xoá đơn hàng này không?
        </div>
        <div class="modal-footer">
          <button type="button" class="admin-btn btn-cancel btn-sm" data-bs-dismiss="modal">Huỷ</button>
          <button type="button" class="admin-btn btn-danger btn-sm" id="btnConfirmDeleteOrder">Xoá</button>
        </div>
      </div>
    </div>
  </div>
  <script src="js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE = 'http://localhost:8080';
    function formatVND(number) {
      if (!number) return '';
      return Number(number).toLocaleString('vi-VN') + '₫';
    }

    function formatOrderItems(items) {
      if (!items) return 'Không có sản phẩm';

      try {
        // Nếu items là string JSON, parse nó
        if (typeof items === 'string') {
          if (items.startsWith('[') || items.startsWith('{')) {
            const parsed = JSON.parse(items);
            if (Array.isArray(parsed)) {
              return parsed.map(item =>
                `${item.productName || 'Sản phẩm'} (x${item.quantity || 1}) - ${formatVND(item.price || 0)}`
              ).join('<br>');
            }
          }
          // Nếu là string thường, hiển thị trực tiếp
          return items;
        }

        // Nếu items là array
        if (Array.isArray(items)) {
          return items.map(item =>
            `${item.productName || 'Sản phẩm'} (x${item.quantity || 1}) - ${formatVND(item.price || 0)}`
          ).join('<br>');
        }

        // Nếu items là object
        if (typeof items === 'object') {
          return `${items.productName || 'Sản phẩm'} (x${items.quantity || 1}) - ${formatVND(items.price || 0)}`;
        }

        return items.toString();
      } catch (e) {
        return items.toString();
      }
    }
    function showToast(message, type = 'success') {
      let icon = '';
      let toastClass = '';
      if (type === 'success') { icon = '✔️'; toastClass = 'toast-success'; }
      else if (type === 'danger' || type === 'error') { icon = '❌'; toastClass = 'toast-error'; }
      else if (type === 'warning') { icon = '⚠️'; toastClass = 'toast-warning'; }
      const toast = document.createElement('div');
      toast.className = `custom-toast ${toastClass}`;
      toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
      document.getElementById('toastContainer').appendChild(toast);
      setTimeout(() => { toast.classList.add('fade-out'); }, 3000);
      setTimeout(() => { toast.remove(); }, 4000);
    }
    function showAdminTab(tab) {
      document.querySelectorAll('.admin-tab').forEach(function (el) {
        el.classList.add('d-none');
      });
      document.getElementById('tab-' + tab).classList.remove('d-none');
      document.querySelectorAll('.admin-sidebar a').forEach(function (a) {
        a.classList.remove('active');
        if (a.getAttribute('data-tab') === tab) a.classList.add('active');
      });
      document.getElementById('adminTabMobile').value = tab;
    }
    document.querySelectorAll('.admin-sidebar a').forEach(function (a) {
      a.addEventListener('click', function (e) {
        e.preventDefault();
        showAdminTab(this.getAttribute('data-tab'));
      });
    });
    document.getElementById('adminTabMobile').addEventListener('change', function () {
      showAdminTab(this.value);
    });
    const productsTableBody = document.querySelector('#productsTable tbody');
    let products = [];
    let filteredProducts = [];
    let currentPage = 1;
    const pageSize = 10;
    let currentSort = { key: '', asc: true };
    function renderProductCount() {
      document.getElementById('productCountBtn').innerText = `Tổng: ${products.length} sản phẩm`;
    }
    document.getElementById('searchInput').addEventListener('input', function () {
      const q = this.value.trim().toLowerCase();
      filteredProducts = products.filter(p =>
        p.name.toLowerCase().includes(q) ||
        formatVND(p.price).includes(q) ||
        p.description.toLowerCase().includes(q)
      );
      currentPage = 1;
      renderProducts();
      renderPagination();
      renderProductCount();
    });
    window.sortTable = function (key) {
      if (currentSort.key === key) currentSort.asc = !currentSort.asc;
      else { currentSort.key = key; currentSort.asc = true; }
      filteredProducts.sort((a, b) => {
        let va = a[key], vb = b[key];
        if (key === 'price') { va = Number(va); vb = Number(vb); }
        if (va < vb) return currentSort.asc ? -1 : 1;
        if (va > vb) return currentSort.asc ? 1 : -1;
        return 0;
      });
      renderSortIcons();
      renderProducts();
    };
    function renderSortIcons() {
      ['id', 'name', 'price', 'description'].forEach(k => {
        document.getElementById('sortIcon-' + k).innerText = (currentSort.key === k) ? (currentSort.asc ? '▲' : '▼') : '';
      });
    }
    function renderPagination() {
      const totalPages = Math.ceil(products.length / pageSize);
      const pag = document.getElementById('pagination');
      pag.innerHTML = '';
      if (totalPages <= 1) return;
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === currentPage ? ' active' : '');
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = function (e) {
          e.preventDefault();
          currentPage = i;
          renderProducts();
          renderPagination();
          setTimeout(() => {
            document.getElementById('productsTable').scrollIntoView({ behavior: 'smooth' });
          }, 50);
        };
        pag.appendChild(li);
      }
    }
    function renderProducts() {
      const tbody = productsTableBody;
      tbody.innerHTML = '';
      let data = filteredProducts;
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      data = data.slice(start, end);
      data.forEach((p, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.name}</td>
          <td>${formatVND(p.price)}</td>
          <td>${p.description}</td>
          <td><img src="${p.image}" alt="" style="max-width:60px;max-height:60px;cursor:pointer;" onclick="showImageModal('${p.image}')"></td>
          <td>
            <button class="admin-btn btn-sm" onclick="editProduct(${products.findIndex(x => x.id === p.id)})">Sửa</button>
            <button class="admin-btn btn-danger btn-sm" onclick="deleteProduct(${products.findIndex(x => x.id === p.id)})">Xoá</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      renderProductCount();
      renderSortIcons();
    }
    async function fetchProducts() {
      showGlobalLoading(true);
      const res = await fetch(`${API_BASE}/api/products`);
      products = await res.json();
      filteredProducts = products.slice();
      currentPage = 1;
      renderProducts();
      renderPagination();
      renderProductCount();
      showGlobalLoading(false);
    }
    document.getElementById('btnAddProduct').onclick = function () {
      document.getElementById('productForm').reset();
      document.getElementById('productRowIndex').value = '';
      document.getElementById('productModalLabel').innerText = 'Thêm sản phẩm';
      document.getElementById('productIdGroup').style.display = 'none';
      updateImageGallery(); // Cập nhật gallery khi thêm
    };
    window.editProduct = function (idx) {
      const p = products[idx];
      document.getElementById('productId').value = p.id;
      document.getElementById('productName').value = p.name;
      document.getElementById('productPrice').value = Number(p.price).toLocaleString('vi-VN');
      document.getElementById('productDescription').value = p.description;
      document.getElementById('productMaterial').value = p.material || '';
      document.getElementById('productSize').value = p.size || '';
      document.getElementById('productWeight').value = p.weight || '';
      document.getElementById('productStatus').value = p.status || 'Còn hàng';
      document.getElementById('productFeatures').value = p.features || '';
      document.getElementById('productStory').value = p.story || '';
      const imagesValue = (p.images || p.image || '').replace(/,/g, '\n');
      document.getElementById('productImage').value = imagesValue;
      setTimeout(() => {
        const textarea = document.getElementById('productImage');
        textarea.style.height = 'auto';
        const newHeight = Math.max(250, textarea.scrollHeight + 30);
        textarea.style.height = Math.min(newHeight, 500) + 'px';
      }, 100);
      document.getElementById('productRowIndex').value = idx + 2; // rowIndex trong sheet (bắt đầu từ 2)
      document.getElementById('productModalLabel').innerText = 'Sửa sản phẩm';
      document.getElementById('productIdGroup').style.display = 'block';
      const urls = (p.images ? p.images.split(/[,]/) : [p.image]).map(s => s.trim()).filter(Boolean).slice(0, 4);
      if (urls.length) {
        imageGalleryPreview.innerHTML = urls.map((url, idx) => `
          <div class="image-preview-item">
            <button type="button" class="image-remove-btn" onclick="removeImage(${idx})" title="Xóa ảnh này">
              <i class="fas fa-times"></i>
            </button>
            <img src="${url}" alt="Preview ${idx + 1}" onclick="showImageModal('${url}', ${idx})">
            <div class="image-label">Ảnh ${idx + 1}</div>
          </div>
        `).join('');
      } else {
        imageGalleryPreview.innerHTML = `
          <div class="image-gallery-empty">
            <i class="fas fa-images"></i>
            <div>Chưa có ảnh nào</div>
            <small>Nhập URL ảnh vào ô bên trên để xem preview (tối đa 4 ảnh)</small>
          </div>
        `;
      }
      var modal = new bootstrap.Modal(document.getElementById('productModal'));
      modal.show();
    };
    function validateProductForm() {
      const name = document.getElementById('productName').value.trim();
      const price = document.getElementById('productPrice').value.replace(/\D/g, '');
      const description = document.getElementById('productDescription').value.trim();
      const material = document.getElementById('productMaterial').value.trim();
      const size = document.getElementById('productSize').value.trim();
      const weight = document.getElementById('productWeight').value.trim();
      const features = document.getElementById('productFeatures').value.trim();
      const story = document.getElementById('productStory').value.trim();
      const image = document.getElementById('productImage').value.trim();
      const imageUrls = image.split(/\n/).map(s => s.trim()).filter(Boolean);
      if (imageUrls.length > 4) {
        showToast('Chỉ được phép thêm tối đa 4 ảnh! Vui lòng xóa bớt ảnh.', 'warning');
        return false;
      }
      if (!name) {
        showToast('Tên sản phẩm không được để trống!', 'warning');
        document.getElementById('productName').focus();
        return false;
      }
      if (!price || isNaN(price) || Number(price) <= 0) {
        showToast('Giá sản phẩm phải là số lớn hơn 0!', 'warning');
        document.getElementById('productPrice').focus();
        return false;
      }
      if (!description) {
        showToast('Mô tả không được để trống!', 'warning');
        document.getElementById('productDescription').focus();
        return false;
      }
      if (!material) {
        showToast('Chất liệu không được để trống!', 'warning');
        document.getElementById('productMaterial').focus();
        return false;
      }
      if (!size) {
        showToast('Kích thước không được để trống!', 'warning');
        document.getElementById('productSize').focus();
        return false;
      }
      if (!weight) {
        showToast('Trọng lượng không được để trống!', 'warning');
        document.getElementById('productWeight').focus();
        return false;
      }
      if (!features) {
        showToast('Đặc điểm nổi bật không được để trống!', 'warning');
        document.getElementById('productFeatures').focus();
        return false;
      }
      if (!story) {
        showToast('Câu chuyện đằng sau sản phẩm không được để trống!', 'warning');
        document.getElementById('productStory').focus();
        return false;
      }
      if (!image) {
        showToast('Ảnh (URL) không được để trống!', 'warning');
        document.getElementById('productImage').focus();
        return false;
      }
      if (!/^https?:\/\//.test(image)) {
        showToast('URL ảnh phải bắt đầu bằng http:// hoặc https://', 'warning');
        document.getElementById('productImage').focus();
        return false;
      }
      return true;
    }
    let deleteIdx = null;
    window.deleteProduct = function (idx) {
      deleteIdx = idx;
      var modal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
      modal.show();
    };
    document.getElementById('btnConfirmDelete').onclick = async function () {
      if (deleteIdx !== null) {
        const rowIndex = deleteIdx + 2;
        showGlobalLoading(true);
        try {
          await fetch(`${API_BASE}/api/products/${rowIndex}`, { method: 'DELETE' });
          showToast('Xoá sản phẩm thành công!', 'danger');
          fetchProducts();
        } catch (e) {
          showToast('Xoá sản phẩm thất bại!', 'danger');
        }
        deleteIdx = null;
        var modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
        modal.hide();
        showGlobalLoading(false);
      }
    };
    const priceInput = document.getElementById('productPrice');
    priceInput.addEventListener('input', function (e) {
      let value = this.value.replace(/\D/g, ''); // chỉ lấy số
      let selectionStart = this.selectionStart;
      let oldLength = this.value.length;
      if (value) {
        this.value = Number(value).toLocaleString('vi-VN') + '₫';
        let newLength = this.value.length;
        this.setSelectionRange(newLength - 1, newLength - 1);
      } else {
        this.value = '';
      }
    });
    priceInput.addEventListener('blur', function () {
      if (!this.value) this.value = '';
      else if (!/₫$/.test(this.value)) this.value += '₫';
    });
    document.getElementById('productForm').onsubmit = async function (e) {
      e.preventDefault();
      if (!validateProductForm()) return;
      const btn = this.querySelector('button[type="submit"]');
      btn.disabled = true;
      showGlobalLoading(true);
      const rowIndex = document.getElementById('productRowIndex').value;
      let imagesArr = document.getElementById('productImage').value
        .split(/\n/)
        .map(s => s.trim())
        .filter(Boolean);
      let imagesStr = imagesArr.join(','); // CHUỖI các url cách nhau dấu phẩy
      let product = {
        name: document.getElementById('productName').value,
        price: document.getElementById('productPrice').value.replace(/\D/g, ''),
        description: document.getElementById('productDescription').value,
        material: document.getElementById('productMaterial').value,
        size: document.getElementById('productSize').value,
        weight: document.getElementById('productWeight').value,
        status: document.getElementById('productStatus').value,
        features: document.getElementById('productFeatures').value,
        story: document.getElementById('productStory').value,
        image: imagesArr[0] || '', // ảnh đại diện
        images: imagesStr // CHUỖI, không phải mảng
      };
      try {
        if (rowIndex) {
          product.id = document.getElementById('productId').value;
          await fetch(`${API_BASE}/api/products/${rowIndex}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(product)
          });
          showToast('Cập nhật sản phẩm thành công!');
        } else {
          await fetch(`${API_BASE}/api/products`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(product)
          });
          showToast('Thêm sản phẩm thành công!');
        }
        var modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
        modal.hide();
        setTimeout(() => { btn.disabled = false; }, 500);
        fetchProducts();
      } catch (e) {
        showToast('Có lỗi xảy ra, vui lòng thử lại!', 'danger');
        btn.disabled = false;
      }
      showGlobalLoading(false);
    };
    const imageInput = document.getElementById('productImage');
    const imageGalleryPreview = document.getElementById('imageGalleryPreview');
    imageInput.addEventListener('input', function () {
      this.style.height = 'auto';
      const newHeight = Math.max(250, this.scrollHeight + 30);
      this.style.height = Math.min(newHeight, 500) + 'px';
      updateImageGallery();
    });
    function updateImageGallery() {
      const urls = imageInput.value.split(/\n/).map(s => s.trim()).filter(Boolean);
      if (urls.length) {
        imageGalleryPreview.innerHTML = urls.map((url, idx) => `
          <div class="image-preview-item">
            <button type="button" class="image-remove-btn" onclick="removeImage(${idx})" title="Xóa ảnh này">
              <i class="fas fa-times"></i>
            </button>
            <img src="${url}" alt="Preview ${idx + 1}" onclick="showImageModal('${url}', ${idx})">
            <div class="image-label">Ảnh ${idx + 1}</div>
          </div>
        `).join('');
        if (urls.length > 4) {
          imageGalleryPreview.innerHTML += `
            <div class="image-gallery-warning">
              <i class="fas fa-exclamation-triangle"></i>
              <div>Quá nhiều ảnh! Chỉ được phép tối đa 4 ảnh</div>
              <small>Vui lòng xóa bớt ${urls.length - 4} ảnh để có thể lưu</small>
            </div>
          `;
        }
      } else {
        imageGalleryPreview.innerHTML = `
          <div class="image-gallery-empty">
            <i class="fas fa-images"></i>
            <div>Chưa có ảnh nào</div>
            <small>Nhập URL ảnh vào ô bên trên để xem preview (tối đa 4 ảnh)</small>
          </div>
        `;
      }
    }
    window.removeImage = function (index) {
      const textarea = document.getElementById('productImage');
      const urls = textarea.value.split(/\n/).map(s => s.trim()).filter(Boolean);
      if (index >= 0 && index < urls.length) {
        urls.splice(index, 1);
        textarea.value = urls.join('\n');
        updateImageGallery();
        showToast('Đã xóa ảnh!', 'warning');
      }
    };
    let currentImageIndex = 0;
    let allImageUrls = [];
    window.switchImage = function (index) {
      if (index >= 0 && index < allImageUrls.length && index !== currentImageIndex) {
        currentImageIndex = index;
        const modalImg = document.getElementById('modalImage');
        const thumbnails = document.querySelectorAll('.modal-thumbnail');
        currentZoom = 1;
        modalImg.style.transform = 'scale(1)';
        modalImg.style.opacity = '0.7';
        setTimeout(() => {
          modalImg.src = allImageUrls[index];
          modalImg.style.opacity = '1';
        }, 150);
        thumbnails.forEach((thumb, idx) => {
          if (idx === index) {
            thumb.classList.add('active');
            thumb.style.transform = 'scale(1.1)';
            setTimeout(() => {
              thumb.style.transform = 'scale(1)';
            }, 200);
          } else {
            thumb.classList.remove('active');
          }
        });
      }
    }
    window.closeImageModal = function () {
      const modal = document.getElementById('imageModal');
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);

      // Kiểm tra và mở lại modal phù hợp
      const productModalEl = document.getElementById('productModal');
      const blogModalEl = document.getElementById('blogModal');
      const productImageTextarea = document.getElementById('productImage');
      const blogImageInput = document.getElementById('blogImage');

      // Ưu tiên mở lại blog modal nếu có dữ liệu
      if (blogModalEl && blogImageInput && blogImageInput.value) {
        var blogModal = new bootstrap.Modal(blogModalEl);
        blogModal.show();
      }
      // Nếu không có blog modal, mở lại product modal nếu có dữ liệu
      else if (productModalEl && productImageTextarea && productImageTextarea.value) {
        var productModal = new bootstrap.Modal(productModalEl);
        productModal.show();
      }
    }
    let currentZoom = 1;
    let isZooming = false;
    window.zoomIn = function () {
      if (isZooming) return; // Tránh spam click
      isZooming = true;
      currentZoom = Math.min(currentZoom * 1.2, 3);
      const modalImg = document.getElementById('modalImage');
      modalImg.style.transform = `scale(${currentZoom})`;
      const btn = event.target.closest('.control-btn');
      if (btn) {
        btn.style.transform = 'scale(0.9)';
        setTimeout(() => {
          btn.style.transform = 'scale(1)';
        }, 150);
      }
      setTimeout(() => {
        isZooming = false;
      }, 300);
    }
    window.zoomOut = function () {
      if (isZooming) return; // Tránh spam click
      isZooming = true;
      currentZoom = Math.max(currentZoom / 1.2, 0.5);
      const modalImg = document.getElementById('modalImage');
      modalImg.style.transform = `scale(${currentZoom})`;
      const btn = event.target.closest('.control-btn');
      if (btn) {
        btn.style.transform = 'scale(0.9)';
        setTimeout(() => {
          btn.style.transform = 'scale(1)';
        }, 150);
      }
      setTimeout(() => {
        isZooming = false;
      }, 300);
    }
    window.resetZoom = function () {
      if (isZooming) return; // Tránh spam click
      isZooming = true;
      currentZoom = 1;
      const modalImg = document.getElementById('modalImage');
      modalImg.style.transform = 'scale(1)';
      const btn = event.target.closest('.control-btn');
      if (btn) {
        btn.style.transform = 'scale(0.9)';
        setTimeout(() => {
          btn.style.transform = 'scale(1)';
        }, 150);
      }
      setTimeout(() => {
        isZooming = false;
      }, 300);
    }
    window.showImageModal = function (url, index = 0) {
      // Kiểm tra xem có phải từ product form không
      const textarea = document.getElementById('productImage');
      let allImageUrls = [];
      let currentImageIndex = 0;

      if (textarea && textarea.value) {
        // Từ product form
        allImageUrls = textarea.value.split(/\n/).map(s => s.trim()).filter(Boolean);
        currentImageIndex = index;
        if (allImageUrls.length === 0) return;
      } else {
        // Từ blog hoặc nơi khác - chỉ hiển thị 1 ảnh
        allImageUrls = [url];
        currentImageIndex = 0;
      }

      const modalImg = document.getElementById('modalImage');
      const modalThumbnails = document.getElementById('modalThumbnails');
      modalImg.src = url;
      currentZoom = 1;
      modalImg.style.transform = 'scale(1)';

      if (allImageUrls.length > 1) {
        modalThumbnails.innerHTML = allImageUrls.map((imgUrl, idx) => `
          <img src="${imgUrl}" alt="Thumbnail ${idx + 1}" 
               class="modal-thumbnail ${idx === currentImageIndex ? 'active' : ''}"
               onclick="switchImage(${idx})">
        `).join('');
        modalThumbnails.style.display = 'flex';
      } else {
        modalThumbnails.style.display = 'none';
      }

      const modal = document.getElementById('imageModal');
      modal.style.display = 'block';
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.opacity = '1';
      }, 10);

      // Chỉ ẩn product modal nếu nó đang mở
      const productModalEl = document.getElementById('productModal');
      if (productModalEl && productModalEl.classList.contains('show')) {
        bootstrap.Modal.getInstance(productModalEl).hide();
      }
    }
    document.getElementById('imageModal').addEventListener('click', function (e) {
      if (e.target === this || e.target.classList.contains('modal-image-content')) {
        closeImageModal();
      }
    });
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && document.getElementById('imageModal').style.display === 'block') {
        closeImageModal();
      }
    });
    document.getElementById('productCountBtn').onclick = function () {
      document.getElementById('productsTable').scrollIntoView({ behavior: 'smooth' });
    };
    let blogs = [];
    let blogCurrentPage = 1;
    const blogPageSize = 10;
    let blogCurrentSort = { key: '', asc: true };
    let allBlogs = [];
    async function fetchBlogs() {
      showGlobalLoading(true);
      const res = await fetch(`${API_BASE}/api/blogs`);
      allBlogs = await res.json();
      blogs = allBlogs.slice();
      blogCurrentPage = 1;
      renderBlogs();
      renderBlogPagination();
      renderBlogCount();
      showGlobalLoading(false);
    }
    function renderBlogCount() {
      document.getElementById('blogCount').innerText = `${blogs.length} bài viết`;
      document.getElementById('blogCountBtn').innerText = `Tổng: ${blogs.length} bài viết`;
    }
    function renderBlogs() {
      const tbody = document.querySelector('#blogsTable tbody');
      tbody.innerHTML = '';
      let data = blogs.slice();
      if (blogCurrentSort.key) {
        data.sort((a, b) => {
          let va = a[blogCurrentSort.key], vb = b[blogCurrentSort.key];
          if (blogCurrentSort.key === 'date') { va = va || ''; vb = vb || ''; }
          if (va < vb) return blogCurrentSort.asc ? -1 : 1;
          if (va > vb) return blogCurrentSort.asc ? 1 : -1;
          return 0;
        });
      }
      const start = (blogCurrentPage - 1) * blogPageSize;
      const end = start + blogPageSize;
      data = data.slice(start, end);
      data.forEach((b, idx) => {
        const tr = document.createElement('tr');
        // Truncate content for better display
        const truncatedContent = b.content.length > 100 ? b.content.substring(0, 100) + '...' : b.content;
        const truncatedTitle = b.title.length > 50 ? b.title.substring(0, 50) + '...' : b.title;

        tr.innerHTML = `
          <td>${b.id}</td>
          <td title="${b.title}">${truncatedTitle}</td>
          <td title="${b.content}">${truncatedContent}</td>
          <td>${b.author}</td>
          <td>${b.date || ''}</td>
          <td>${b.image ? `<img src="${b.image}" alt="${b.title}" style="max-width:60px;max-height:60px;cursor:pointer;object-fit:cover;border-radius:4px;" onclick="showImageModal('${b.image}')">` : '<span class="text-muted">Không có ảnh</span>'}</td>
          <td>
            <button class="admin-btn btn-sm" onclick="editBlog(${idx})">Sửa</button>
            <button class="admin-btn btn-danger btn-sm" onclick="deleteBlog(${idx})">Xoá</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      renderBlogCount();
      renderBlogSortIcons();
    }
    function renderBlogSortIcons() {
      ['id', 'title', 'content', 'author', 'date'].forEach(k => {
        document.getElementById('sortBlogIcon-' + k).innerText = (blogCurrentSort.key === k) ? (blogCurrentSort.asc ? '▲' : '▼') : '';
      });
    }
    function renderBlogPagination() {
      const totalPages = Math.ceil(blogs.length / blogPageSize);
      const pag = document.getElementById('blogPagination');
      pag.innerHTML = '';
      if (totalPages <= 1) return;
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === blogCurrentPage ? ' active' : '');
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = function (e) {
          e.preventDefault();
          blogCurrentPage = i;
          renderBlogs();
          renderBlogPagination();
          setTimeout(() => {
            document.getElementById('blogsTable').scrollIntoView({ behavior: 'smooth' });
          }, 50);
        };
        pag.appendChild(li);
      }
    }
    document.getElementById('searchBlogInput').addEventListener('input', function () {
      const q = this.value.trim().toLowerCase();
      blogs = allBlogs.filter(b =>
        b.title.toLowerCase().includes(q) ||
        b.content.toLowerCase().includes(q) ||
        b.author.toLowerCase().includes(q)
      );
      blogCurrentPage = 1;
      renderBlogs();
      renderBlogPagination();
      renderBlogCount();
    });
    document.getElementById('btnAddBlog').onclick = function () {
      document.getElementById('blogForm').reset();
      document.getElementById('blogRowIndex').value = '';
      document.getElementById('blogId').value = '';
      // Ẩn field ID khi thêm mới
      document.getElementById('blogIdGroup').style.display = 'none';
      document.getElementById('blogModalLabel').innerText = 'Thêm bài viết';
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      document.getElementById('blogDate').value = `${yyyy}-${mm}-${dd}`;

      // Ẩn preview ảnh khi thêm mới
      document.getElementById('blogImagePreview').style.display = 'none';
    };
    window.editBlog = function (idx) {
      const b = blogs[idx];
      document.getElementById('blogId').value = b.id;
      document.getElementById('blogTitle').value = b.title;
      document.getElementById('blogContent').value = b.content;
      document.getElementById('blogAuthor').value = b.author;
      document.getElementById('blogDate').value = b.date || '';
      document.getElementById('blogImage').value = b.image || '';

      // Hiển thị preview ảnh nếu có
      const imageUrl = b.image || '';
      const preview = document.getElementById('blogImagePreview');
      const previewImg = preview.querySelector('img');
      if (imageUrl && imageUrl.startsWith('http')) {
        previewImg.src = imageUrl;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }

      // Hiển thị field ID khi edit
      document.getElementById('blogIdGroup').style.display = 'block';
      // Tìm index thực tế trong allBlogs
      const realIndex = allBlogs.findIndex(x => x.id === b.id);
      document.getElementById('blogRowIndex').value = realIndex + 2;
      document.getElementById('blogModalLabel').innerText = 'Sửa bài viết';
      var modal = new bootstrap.Modal(document.getElementById('blogModal'));
      modal.show();
    };
    let blogDeleteIdx = null;
    window.deleteBlog = function (idx) {
      blogDeleteIdx = idx;
      var modal = new bootstrap.Modal(document.getElementById('deleteBlogConfirmModal'));
      modal.show();
    };
    document.getElementById('btnConfirmDeleteBlog').onclick = async function () {
      if (blogDeleteIdx !== null) {
        const b = blogs[blogDeleteIdx];
        // Tìm index thực tế trong allBlogs
        const realIndex = allBlogs.findIndex(x => x.id === b.id);
        const rowIndex = realIndex + 2;
        showGlobalLoading(true);
        try {
          await fetch(`${API_BASE}/api/blogs/${rowIndex}`, { method: 'DELETE' });
          showToast('Xoá bài viết thành công!', 'danger');
          fetchBlogs();
        } catch (e) {
          showToast('Xoá bài viết thất bại!', 'danger');
        }
        blogDeleteIdx = null;
        var modal = bootstrap.Modal.getInstance(document.getElementById('deleteBlogConfirmModal'));
        modal.hide();
        showGlobalLoading(false);
      }
    };
    function validateBlogForm() {
      const title = document.getElementById('blogTitle').value.trim();
      const content = document.getElementById('blogContent').value.trim();
      const author = document.getElementById('blogAuthor').value.trim();
      const date = document.getElementById('blogDate').value.trim();
      if (!title) {
        showToast('Tiêu đề không được để trống!', 'warning');
        return false;
      }
      if (!content) {
        showToast('Nội dung không được để trống!', 'warning');
        return false;
      }
      if (!author) {
        showToast('Tác giả không được để trống!', 'warning');
        return false;
      }
      if (!date) {
        showToast('Ngày không được để trống!', 'warning');
        return false;
      }
      return true;
    }
    document.getElementById('blogForm').onsubmit = async function (e) {
      e.preventDefault();
      if (!validateBlogForm()) return;
      const btn = this.querySelector('button[type="submit"]');
      btn.disabled = true;
      showGlobalLoading(true);
      const rowIndex = document.getElementById('blogRowIndex').value;
      let blog = {
        id: document.getElementById('blogId').value || '',
        title: document.getElementById('blogTitle').value,
        content: document.getElementById('blogContent').value,
        author: document.getElementById('blogAuthor').value,
        date: document.getElementById('blogDate').value,
        image: document.getElementById('blogImage').value
      };
      try {
        if (rowIndex) {
          await fetch(`${API_BASE}/api/blogs/${rowIndex}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(blog)
          });
          showToast('Cập nhật bài viết thành công!');
        } else {
          await fetch(`${API_BASE}/api/blogs`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(blog)
          });
          showToast('Thêm bài viết thành công!');
        }
        var modal = bootstrap.Modal.getInstance(document.getElementById('blogModal'));
        modal.hide();
        setTimeout(() => { btn.disabled = false; }, 500);
        fetchBlogs();
      } catch (e) {
        showToast('Có lỗi xảy ra, vui lòng thử lại!', 'danger');
        btn.disabled = false;
      }
      showGlobalLoading(false);
    };
    document.querySelector('a[data-tab="blogs"]').addEventListener('click', fetchBlogs);

    // Quản lý đơn hàng
    const ordersTableBody = document.querySelector('#ordersTable tbody');
    let orders = [];
    let allOrders = [];
    let orderCurrentPage = 1;
    const orderPageSize = 10;
    let orderCurrentSort = { key: '', asc: true };

    function renderOrderCount() {
      document.getElementById('orderCountBtn').innerText = `Tổng: ${orders.length} đơn hàng`;
    }

    async function fetchOrders() {
      showGlobalLoading(true);
      try {
        const response = await fetch(`${API_BASE}/api/orders`);
        allOrders = await response.json();
        orders = [...allOrders];
        orderCurrentPage = 1;
        renderOrders();
        renderOrderPagination();
        renderOrderCount();
      } catch (e) {
        showToast('Không thể tải danh sách đơn hàng!', 'danger');
      }
      showGlobalLoading(false);
    }

    function renderOrders() {
      const tbody = ordersTableBody;
      tbody.innerHTML = '';
      const start = (orderCurrentPage - 1) * orderPageSize;
      const end = start + orderPageSize;
      const data = orders.slice(start, end);

      data.forEach((o, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${o.id}</td>
          <td>${o.date}</td>
          <td>${o.customerName}</td>
          <td>${o.customerPhone}</td>
          <td>${formatVND(o.total)}</td>
                      <td>
              <select class="form-control form-control-sm order-status-select ${getStatusClass(o.status)}" onchange="updateOrderStatus('${o.id}', this.value)">
                <option value="Chờ xử lý" ${o.status === 'Chờ xử lý' ? 'selected' : ''}>Chờ xử lý</option>
                <option value="Đã xác nhận" ${o.status === 'Đã xác nhận' ? 'selected' : ''}>Đã xác nhận</option>
                <option value="Đang giao hàng" ${o.status === 'Đang giao hàng' ? 'selected' : ''}>Đang giao hàng</option>
                <option value="Đã giao hàng" ${o.status === 'Đã giao hàng' ? 'selected' : ''}>Đã giao hàng</option>
                <option value="Đã hủy" ${o.status === 'Đã hủy' ? 'selected' : ''}>Đã hủy</option>
              </select>
            </td>
          <td>
            <button class="admin-btn btn-sm" onclick="viewOrderDetail(${idx})">Xem</button>
          </td>
          <td>
            <button class="admin-btn btn-sm" onclick="editOrder(${idx})">Sửa</button>
            <button class="admin-btn btn-danger btn-sm" onclick="deleteOrder(${idx})">Xoá</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      renderOrderCount();
      renderOrderSortIcons();
    }

    function getStatusBadgeClass(status) {
      switch (status) {
        case 'Chờ xử lý': return 'bg-warning';
        case 'Đã xác nhận': return 'bg-info';
        case 'Đang giao hàng': return 'bg-primary';
        case 'Đã giao hàng': return 'bg-success';
        case 'Đã hủy': return 'bg-danger';
        default: return 'bg-secondary';
      }
    }

    function getStatusClass(status) {
      switch (status) {
        case 'Chờ xử lý': return 'status-pending';
        case 'Đã xác nhận': return 'status-confirmed';
        case 'Đang giao hàng': return 'status-shipping';
        case 'Đã giao hàng': return 'status-delivered';
        case 'Đã hủy': return 'status-cancelled';
        default: return '';
      }
    }

    function renderOrderSortIcons() {
      ['id', 'date', 'customerName', 'customerPhone', 'total', 'status'].forEach(k => {
        document.getElementById('sortOrderIcon-' + k).innerText = (orderCurrentSort.key === k) ? (orderCurrentSort.asc ? '▲' : '▼') : '';
      });
    }

    function renderOrderPagination() {
      const totalPages = Math.ceil(orders.length / orderPageSize);
      const pag = document.getElementById('orderPagination');
      pag.innerHTML = '';
      if (totalPages <= 1) return;
      for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = 'page-item' + (i === orderCurrentPage ? ' active' : '');
        li.innerHTML = `<a class="page-link" href="#">${i}</a>`;
        li.onclick = function (e) {
          e.preventDefault();
          orderCurrentPage = i;
          renderOrders();
          renderOrderPagination();
          setTimeout(() => {
            document.getElementById('ordersTable').scrollIntoView({ behavior: 'smooth' });
          }, 50);
        };
        pag.appendChild(li);
      }
    }

    window.sortOrderTable = function (key) {
      if (orderCurrentSort.key === key) orderCurrentSort.asc = !orderCurrentSort.asc;
      else { orderCurrentSort.key = key; orderCurrentSort.asc = true; }
      orders.sort((a, b) => {
        let va = a[key], vb = b[key];
        if (key === 'total') { va = Number(va); vb = Number(vb); }
        if (va < vb) return orderCurrentSort.asc ? -1 : 1;
        if (va > vb) return orderCurrentSort.asc ? 1 : -1;
        return 0;
      });
      orderCurrentPage = 1;
      renderOrders();
      renderOrderPagination();
    };

    document.getElementById('searchOrderInput').addEventListener('input', function () {
      const q = this.value.trim().toLowerCase();
      orders = allOrders.filter(o =>
        o.id.toLowerCase().includes(q) ||
        o.customerName.toLowerCase().includes(q) ||
        o.customerPhone.includes(q)
      );
      orderCurrentPage = 1;
      renderOrders();
      renderOrderPagination();
      renderOrderCount();
    });

    document.getElementById('btnAddOrder').onclick = function () {
      document.getElementById('orderForm').reset();
      document.getElementById('orderRowIndex').value = '';
      document.getElementById('orderId').value = '';
      document.getElementById('orderIdGroup').style.display = 'none';
      document.getElementById('orderModalLabel').innerText = 'Thêm đơn hàng';
      // Tạo mã đơn hàng mới
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let orderId = 'MTS';
      for (let i = 0; i < 6; i++) {
        orderId += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById('orderId').value = orderId;
    };

    window.editOrder = function (idx) {
      const o = orders[idx];
      document.getElementById('orderId').value = o.id;
      document.getElementById('orderCustomerName').value = o.customerName;
      document.getElementById('orderCustomerPhone').value = o.customerPhone;
      document.getElementById('orderCustomerEmail').value = o.customerEmail || '';
      document.getElementById('orderCustomerAddress').value = o.customerAddress;
      document.getElementById('orderCustomerProvince').value = o.customerProvince;
      document.getElementById('orderCustomerDistrict').value = o.customerDistrict;
      document.getElementById('orderCustomerWard').value = o.customerWard;
      document.getElementById('orderTotal').value = o.total;
      // Format items for display in textarea
      let itemsText = '';
      if (o.items) {
        try {
          if (typeof o.items === 'string') {
            if (o.items.startsWith('[') || o.items.startsWith('{')) {
              const parsed = JSON.parse(o.items);
              if (Array.isArray(parsed)) {
                itemsText = parsed.map(item =>
                  `${item.productName || 'Sản phẩm'} (x${item.quantity || 1}) - ${formatVND(item.price || 0)}`
                ).join('\n');
              } else {
                itemsText = o.items;
              }
            } else {
              itemsText = o.items;
            }
          } else if (Array.isArray(o.items)) {
            itemsText = o.items.map(item =>
              `${item.productName || 'Sản phẩm'} (x${item.quantity || 1}) - ${formatVND(item.price || 0)}`
            ).join('\n');
          } else {
            itemsText = o.items.toString();
          }
        } catch (e) {
          itemsText = o.items.toString();
        }
      }
      document.getElementById('orderItems').value = itemsText;
      document.getElementById('orderNote').value = o.note || '';
      document.getElementById('orderStatus').value = o.status;

      document.getElementById('orderIdGroup').style.display = 'block';
      const realIndex = allOrders.findIndex(x => x.id === o.id);
      document.getElementById('orderRowIndex').value = realIndex + 2;
      document.getElementById('orderModalLabel').innerText = 'Sửa đơn hàng';
      var modal = new bootstrap.Modal(document.getElementById('orderModal'));
      modal.show();
    };

    window.viewOrderDetail = function (idx) {
      const o = orders[idx];
      const detailHtml = `
        <div class="modal-header">
          <h5 class="modal-title">Chi tiết đơn hàng ${o.id}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <h6>Thông tin khách hàng</h6>
              <p><strong>Tên:</strong> ${o.customerName}</p>
              <p><strong>Số điện thoại:</strong> ${o.customerPhone}</p>
              <p><strong>Email:</strong> ${o.customerEmail || 'Không có'}</p>
              <p><strong>Địa chỉ:</strong> ${o.customerAddress}</p>
              <p><strong>Tỉnh/Thành:</strong> ${o.customerProvince}</p>
              <p><strong>Quận/Huyện:</strong> ${o.customerDistrict}</p>
              <p><strong>Phường/Xã:</strong> ${o.customerWard}</p>
            </div>
            <div class="col-md-6">
              <h6>Thông tin đơn hàng</h6>
              <p><strong>Mã đơn hàng:</strong> ${o.id}</p>
              <p><strong>Ngày đặt:</strong> ${o.date}</p>
              <p><strong>Tổng tiền:</strong> ${formatVND(o.total)}</p>
              <p><strong>Trạng thái:</strong> <span class="badge ${getStatusBadgeClass(o.status)}">${o.status}</span></p>
              <p><strong>Sản phẩm:</strong></p>
              <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                ${formatOrderItems(o.items)}
              </div>
              <p><strong>Ghi chú:</strong> ${o.note || 'Không có'}</p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="admin-btn btn-sm" data-bs-dismiss="modal">Đóng</button>
        </div>
      `;

      const modal = document.createElement('div');
      modal.className = 'modal fade';
      modal.innerHTML = `
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            ${detailHtml}
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
      modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
      });
    };

    // Function to update order status from detail popup
    window.updateOrderStatus = async function (orderId, newStatus) {
      try {
        const order = orders.find(o => o.id === orderId);
        if (!order) {
          showToast('Không tìm thấy đơn hàng!', 'error');
          return;
        }

        const realIndex = allOrders.findIndex(x => x.id === orderId);
        const rowIndex = realIndex + 2;

        // Update order status
        order.status = newStatus;

        await fetch(`${API_BASE}/api/orders/${rowIndex}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(order)
        });

        showToast('Cập nhật trạng thái thành công!');

        // Update select element styling
        updateOrderStatusStyling(orderId, newStatus);

        // Refresh orders list
        fetchOrders();
      } catch (e) {
        showToast('Cập nhật trạng thái thất bại!', 'error');
      }
    };

    // Function to update select element styling based on status
    function updateOrderStatusStyling(orderId, status) {
      const selectElement = document.querySelector(`select[onchange*="${orderId}"]`);
      if (selectElement) {
        // Remove all status classes
        selectElement.classList.remove('status-pending', 'status-confirmed', 'status-shipping', 'status-delivered', 'status-cancelled');

        // Add appropriate class based on status
        switch (status) {
          case 'Chờ xử lý':
            selectElement.classList.add('status-pending');
            break;
          case 'Đã xác nhận':
            selectElement.classList.add('status-confirmed');
            break;
          case 'Đang giao hàng':
            selectElement.classList.add('status-shipping');
            break;
          case 'Đã giao hàng':
            selectElement.classList.add('status-delivered');
            break;
          case 'Đã hủy':
            selectElement.classList.add('status-cancelled');
            break;
        }
      }
    }

    let orderDeleteIdx = null;
    window.deleteOrder = function (idx) {
      orderDeleteIdx = idx;
      var modal = new bootstrap.Modal(document.getElementById('deleteOrderConfirmModal'));
      modal.show();
    };

    document.getElementById('btnConfirmDeleteOrder').onclick = async function () {
      if (orderDeleteIdx !== null) {
        const o = orders[orderDeleteIdx];
        const realIndex = allOrders.findIndex(x => x.id === o.id);
        const rowIndex = realIndex + 2;
        showGlobalLoading(true);
        try {
          await fetch(`${API_BASE}/api/orders/${rowIndex}`, { method: 'DELETE' });
          showToast('Xoá đơn hàng thành công!', 'danger');
          fetchOrders();
        } catch (e) {
          showToast('Xoá đơn hàng thất bại!', 'danger');
        }
        orderDeleteIdx = null;
        var modal = bootstrap.Modal.getInstance(document.getElementById('deleteOrderConfirmModal'));
        modal.hide();
        showGlobalLoading(false);
      }
    };

    function validateOrderForm() {
      const customerName = document.getElementById('orderCustomerName').value.trim();
      const customerPhone = document.getElementById('orderCustomerPhone').value.trim();
      const customerAddress = document.getElementById('orderCustomerAddress').value.trim();
      const customerProvince = document.getElementById('orderCustomerProvince').value.trim();
      const customerDistrict = document.getElementById('orderCustomerDistrict').value.trim();
      const customerWard = document.getElementById('orderCustomerWard').value.trim();
      const total = document.getElementById('orderTotal').value.trim();
      const items = document.getElementById('orderItems').value.trim();
      const status = document.getElementById('orderStatus').value;

      if (!customerName) {
        showToast('Tên khách hàng không được để trống!', 'warning');
        return false;
      }
      if (!customerPhone) {
        showToast('Số điện thoại không được để trống!', 'warning');
        return false;
      }
      if (!customerAddress) {
        showToast('Địa chỉ không được để trống!', 'warning');
        return false;
      }
      if (!customerProvince) {
        showToast('Tỉnh/Thành phố không được để trống!', 'warning');
        return false;
      }
      if (!customerDistrict) {
        showToast('Quận/Huyện không được để trống!', 'warning');
        return false;
      }
      if (!customerWard) {
        showToast('Phường/Xã không được để trống!', 'warning');
        return false;
      }
      if (!total) {
        showToast('Tổng tiền không được để trống!', 'warning');
        return false;
      }
      if (!items) {
        showToast('Sản phẩm không được để trống!', 'warning');
        return false;
      }
      return true;
    }

    document.getElementById('orderForm').onsubmit = async function (e) {
      e.preventDefault();
      if (!validateOrderForm()) return;
      const btn = this.querySelector('button[type="submit"]');
      btn.disabled = true;
      showGlobalLoading(true);
      const rowIndex = document.getElementById('orderRowIndex').value;
      let order = {
        id: document.getElementById('orderId').value,
        date: document.getElementById('orderRowIndex').value ? orders[orderDeleteIdx].date : new Date().toLocaleString('vi-VN'),
        customerName: document.getElementById('orderCustomerName').value,
        customerPhone: document.getElementById('orderCustomerPhone').value,
        customerEmail: document.getElementById('orderCustomerEmail').value,
        customerAddress: document.getElementById('orderCustomerAddress').value,
        customerProvince: document.getElementById('orderCustomerProvince').value,
        customerDistrict: document.getElementById('orderCustomerDistrict').value,
        customerWard: document.getElementById('orderCustomerWard').value,
        items: document.getElementById('orderItems').value,
        total: document.getElementById('orderTotal').value,
        note: document.getElementById('orderNote').value,
        status: document.getElementById('orderStatus').value
      };
      try {
        if (rowIndex) {
          await fetch(`${API_BASE}/api/orders/${rowIndex}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(order)
          });
          showToast('Cập nhật đơn hàng thành công!');
        } else {
          // Thêm mới - sử dụng API POST hiện tại
          const orderRow = [
            order.id,
            order.date,
            order.customerName,
            order.customerPhone,
            order.customerEmail,
            order.customerAddress,
            order.customerProvince,
            order.customerDistrict,
            order.customerWard,
            order.items,
            order.total,
            order.note,
            order.status
          ];
          await fetch(`${API_BASE}/api/orders`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderRow)
          });
          showToast('Thêm đơn hàng thành công!');
        }
        var modal = bootstrap.Modal.getInstance(document.getElementById('orderModal'));
        modal.hide();
        setTimeout(() => { btn.disabled = false; }, 500);
        fetchOrders();
      } catch (e) {
        showToast('Có lỗi xảy ra, vui lòng thử lại!', 'danger');
        btn.disabled = false;
      }
      showGlobalLoading(false);
    };

    document.querySelector('a[data-tab="orders"]').addEventListener('click', fetchOrders);

    // Blog image preview functionality
    document.getElementById('blogImage').addEventListener('input', function () {
      const imageUrl = this.value.trim();
      const preview = document.getElementById('blogImagePreview');
      const previewImg = preview.querySelector('img');

      if (imageUrl && imageUrl.startsWith('http')) {
        previewImg.src = imageUrl;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
    });

    // Function to show image modal from blog form
    window.showBlogImageModal = function (imageUrl) {
      if (!imageUrl || !imageUrl.startsWith('http')) {
        showToast('URL ảnh không hợp lệ!', 'warning');
        return;
      }

      const modalImg = document.getElementById('modalImage');
      const modalThumbnails = document.getElementById('modalThumbnails');

      modalImg.src = imageUrl;
      currentZoom = 1;
      modalImg.style.transform = 'scale(1)';

      // Ẩn thumbnails vì chỉ có 1 ảnh
      modalThumbnails.style.display = 'none';

      const modal = document.getElementById('imageModal');
      modal.style.display = 'block';
      modal.style.opacity = '0';
      setTimeout(() => {
        modal.style.opacity = '1';
      }, 10);

      // Ẩn blog modal tạm thời
      const blogModalEl = document.getElementById('blogModal');
      if (blogModalEl && blogModalEl.classList.contains('show')) {
        bootstrap.Modal.getInstance(blogModalEl).hide();
      }
    };

    fetchProducts();
    function showGlobalLoading(show = true) {
      document.getElementById('globalLoading').style.display = show ? 'flex' : 'none';
    }
  </script>
</body>

</html>